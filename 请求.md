- ## 一、登录认证流程分析

  ### 1. 登录步骤

  1. __访问登录页面__: `https://business.gemini.google/` → 重定向到 `https://auth.business.gemini.google/login`

  2. __输入邮箱__: 发送POST请求到验证码服务

  3. __验证码验证__:

     - 向邮箱发送6位验证码（示例：KRTZNL）
     - POST请求：`https://accountverification.business.gemini.google/v1/verify-oob-code`
     - 包含OAuth2授权参数和加密的用户标识

  ### 2. 关键认证请求

  - __OAuth2授权__: `GET https://accountverification.business.gemini.google/oauth2/authorize`
  - __验证码验证__: `POST https://accountverification.business.gemini.google/v1/verify-oob-code`
  - __会话建立__: 成功后重定向到主页面并设置cookie

  ## 二、API请求流程分析

  ### 核心API端点

  1. __会话创建__：

     ```javascript
     POST https://biz-discoveryengine.googleapis.com/v1alpha/locations/global/widgetCreateSession
     ```

  2. __流式助手请求__（主要API）：

     ```javascript
     POST https://biz-discoveryengine.googleapis.com/v1alpha/locations/global/widgetStreamAssist
     ```

  ### 关键请求头

  ```http
  Authorization: Bearer {长JWT令牌}
  Content-Type: application/json
  x-server-timeout: 1800
  Origin: https://business.gemini.google
  Referer: https://business.gemini.google/
  User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36...
  ```

  ### 请求体结构

  ```json
  {
    "configId": "d06739ca-6683-46db-bb51-07395a392439",
    "additionalParams": {"token": "-"},
    "streamAssistRequest": {
      "session": "collections/default_collection/engines/agentspace-engine/sessions/10623580602901355290",
      "query": {"parts": [{"text": "用户消息"}]},
      "filter": "",
      "fileIds": [],
      "answerGenerationMode": "NORMAL",
      "toolsSpec": {
        "webGroundingSpec": {},
        "toolRegistry": "default_tool_registry",
        "imageGenerationSpec": {},
        "videoGenerationSpec": {}
      },
      "languageCode": "zh",
      "userMetadata": {"timeZone": "Asia/Shanghai"},
      "assistSkippingMode": "REQUEST_ASSIST"
    }
  }
  ```

  ## 三、Docker部署配置建议

  ### 1. 环境变量配置（使用-e参数，不存文件）

  ```bash
  docker run -d \
    -e GEMINI_BUSINESS_URL="https://business.gemini.google" \
    -e API_BASE_URL="https://biz-discoveryengine.googleapis.com/v1alpha" \
    -e AUTH_URL="https://auth.business.gemini.google" \
    -e ACCOUNT_EMAIL="2123146130@qq.com" \
    -e SESSION_TIMEOUT="1800" \
    -e LOG_LEVEL="info" \
    -e STDOUT_LOGGING="true" \
    -p 8080:8080 \
    bailangvvking/gemini-business-proxy
  ```

  ### 2. Go程序Dockerfile示例

  ```dockerfile
  FROM golang:1.21-alpine AS builder
  WORKDIR /app
  COPY go.mod go.sum ./
  RUN go mod download
  COPY . .
  RUN CGO_ENABLED=0 GOOS=linux go build -o gemini-proxy ./cmd/server
  
  FROM alpine:latest
  RUN apk --no-cache add ca-certificates
  WORKDIR /root/
  COPY --from=builder /app/gemini-proxy .
  EXPOSE 8080
  CMD ["./gemini-proxy"]
  ```

  ### 3. 代理器配置（OpenAI格式兼容）

  ```yaml
  # config.yaml
  server:
    port: 8080
    host: "0.0.0.0"
  
  gemini:
    business_url: "${GEMINI_BUSINESS_URL}"
    api_base_url: "${API_BASE_URL}"
    auth_url: "${AUTH_URL}"
  
  openai_compatible:
    enabled: true
    api_key_header: "Authorization"
    model_mapping:
      "gpt-3.5-turbo": "gemini-business"
      "gpt-4": "gemini-business-pro"
  
  logging:
    level: "${LOG_LEVEL}"
    stdout: "${STDOUT_LOGGING}"
    format: "json"
  ```

  ### 4. 日志标准输出到Docker

  ```go
  // 在Go程序中使用标准输出
  log.SetOutput(os.Stdout)
  log.SetFormatter(&log.JSONFormatter{})
  log.WithFields(log.Fields{
    "service": "gemini-proxy",
    "request_id": requestID,
  }).Info("API Request processed")
  ```

  ## 四、实现要点

  1. __认证流程自动化__: 需要处理OAuth2授权、验证码验证和会话管理
  2. __API请求封装__: 将Gemini Business API封装成OpenAI兼容格式
  3. __流式响应支持__: 支持Server-Sent Events (SSE) 用于流式响应
  4. __错误处理__: 完善的错误处理和重试机制
  5. __配置管理__: 通过环境变量注入所有配置，无需配置文件

  ## 五、使用示例

  ```bash
  # 启动代理服务
  docker run -d \
    -e GEMINI_BUSINESS_URL="https://business.gemini.google" \
    -e API_BASE_URL="https://biz-discoveryengine.googleapis.com/v1alpha" \
    -e ACCOUNT_EMAIL="your-email@example.com" \
    -p 8080:8080 \
    gemini-business-proxy
  
  # 使用OpenAI格式调用
  curl -X POST http://localhost:8080/v1/chat/completions \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer your-api-key" \
    -d '{
      "model": "gpt-3.5-turbo",
      "messages": [
        {"role": "user", "content": "Hello, test API request"}
      ],
      "stream": true
    }'
  ```

  整个流程分析已完成，包括完整的登录认证、API请求结构和Docker部署配置建议。