## 1. 登录流程分析

### 关键API端点：

- __登录邮箱提交__：`https://accountverification.business.gemini.google/v1/verify-oob-code`
- __验证码验证__：`https://accountverification.business.gemini.google/_/IdentityPlatformFrontendUI/data/batchexecute`
- __OAuth授权__：`https://accountverification.business.gemini.google/oauth2/authorize`

### 认证机制：

- 使用OAuth 2.0流程，包含`client_id`、`redirect_uri`、`state`、`scope`、`nonce`等标准参数
- 验证码通过邮箱发送，通过单独的验证码验证接口验证
- 最终通过重定向和cookie设置完成登录

## 2. 聊天API调用分析

### 核心API端点：

- __会话创建__：`POST https://biz-discoveryengine.googleapis.com/v1alpha/locations/global/widgetCreateSession`
- __流式聊天__：`POST https://biz-discoveryengine.googleapis.com/v1alpha/locations/global/widgetStreamAssist`
- __查询补全__：`POST https://biz-discoveryengine.googleapis.com/v1alpha/locations/global/widgetAdvancedCompleteQuery`

### 请求头详细信息：

```javascript
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVC...
Content-Type: application/json
sec-ch-ua: "Not/A)Brand";v="8", "Chromium";v="126", "Google Chrome";v="126"
sec-ch-ua-arch: "x86"
sec-ch-ua-platform: "Windows"
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36...
Referer: https://business.gemini.google/
Origin: https://business.gemini.google
```

### 流式聊天请求体格式：

```json
{
  "configId": "d06739ca-6683-46db-bb51-07395a392439",
  "additionalParams": {"token": "-"},
  "streamAssistRequest": {
    "session": "collections/default_collection/engines/agentspace-engine/sessions/12819925172900804070",
    "query": {"parts": [{"text": "你好，请介绍一下Gemini Business的API调用流程"}]},
    "filter": "",
    "fileIds": [],
    "answerGenerationMode": "NORMAL",
    "toolsSpec": {
      "webGroundingSpec": {},
      "toolRegistry": "default_tool_registry",
      "imageGenerationSpec": {},
      "videoGenerationSpec": {}
    },
    "languageCode": "zh",
    "userMetadata": {"timeZone": "Asia/Shanghai"},
    "assistSkippingMode": "REQUEST_ASSIST"
  }
}
```

### 流式响应格式：

- 使用SSE（Server-Sent Events）流式响应
- 每个响应块包含`uToken`和`streamAssistResponse`
- 响应结构包含`answer`对象，其中有`state`、`replies`数组和`adkAuthor`
- 每条回复包含`groundedContent`，其中有`role`和`text`

## 3. 关键发现总结

### 认证令牌：

- 使用JWT格式的Bearer Token，包含用户信息和过期时间
- Token通过登录流程获得，有效期为5分钟

### 会话管理：

- 每个聊天会话有唯一的session ID
- 会话格式：`collections/default_collection/engines/agentspace-engine/sessions/{session_id}`

### 请求参数：

- `configId`：企业配置ID（如d06739ca-6683-46db-bb51-07395a392439）
- `languageCode`：语言代码（如zh）
- `answerGenerationMode`：回答生成模式（NORMAL）
- `toolsSpec`：工具规范配置
- `userMetadata`：用户元数据，包含时区等信息